<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Fact Families</title>
<style>
  :root{
    --bg:#0b1020; --card:#111827; --text:#e5e7eb; --muted:#9aa3b2; --ring:#334155;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --bar:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1600px 600px at 50% -20%, #1e293b33, transparent 50%), var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  h1{font-size:clamp(28px,5vw,46px);font-weight:900;text-align:center;margin:16px 0 4px;color:#fcd34d}
  .wrap{max-width:1180px;margin:0 auto;padding:14px;display:grid;gap:14px}
  .card{background:rgba(17,24,39,.9);border:1px solid var(--ring);border-radius:14px;padding:12px 14px}
  .top{display:grid;gap:12px;grid-template-columns:1.1fr 2.1fr 1.2fr;align-items:start}
  @media (max-width:1100px){.top{grid-template-columns:1fr 1fr}}
  @media (max-width:760px){.top{grid-template-columns:1fr}}

  .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .stat .label{font-size:12px;color:var(--muted)} .stat .val{font-size:20px;font-weight:700}
  .pers{margin-top:6px;font-size:13px;color:#cbd5e1}
  .feedback{margin-top:6px;font-size:14px;color:#eab308}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chipgroup{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .chip{border:1px solid var(--ring);background:#0b1223;color:#e5e7eb;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700}
  .chip.active{border-color:#22c55e;box-shadow:0 0 0 2px #09321b inset}
  .caps{font-variant:all-small-caps;letter-spacing:.5px;color:#9aa3b2}

  .btn{background:#0b1223;color:#e5e7eb;border:1px solid var(--ring);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.primary{border-color:#22c55e}.btn.warn{border-color:#f59e0b}.btn.stop{border-color:#ef4444}
  .btn.big{font-size:clamp(18px,3vw,24px);padding:14px 22px;border-width:2px}

  .time-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .time-big{font-variant-numeric:tabular-nums;font-size:26px;font-weight:800}
  .progress{height:12px;background:var(--bar);border-radius:999px;overflow:hidden;outline:1px solid #334155;margin:12px 0 16px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s ease}

  .stage{display:flex;align-items:center;justify-content:center;text-align:center;background:radial-gradient(1200px 300px at 50% -40%, #22c55e1f, transparent 60%);padding:12px;border-radius:12px}
  .stage--tight{min-height:110px}
  .eq{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;font-size:clamp(28px,5vw,56px);user-select:none}
  .cell{display:inline-flex;align-items:center;justify-content:center;min-width:1.2em}
  .op,.eqsign{opacity:.95}
  .numbox{display:inline-flex;align-items:center;justify-content:center;width:5.2ch;padding:.45em .85em;height:2.1em;border-radius:14px;border:3px solid #374151;font-weight:900;background:#0b1223;color:#e5e7eb;outline:none;text-align:center;font-size:1em}
  .numbox.ok{border-color:#22c55e;background:#063019;color:#a7f3d0}
  .numbox.err{border-color:#ef4444;background:#3b0a0a;color:#fecaca}
  .numbox::-webkit-outer-spin-button,.numbox::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input.numbox{-moz-appearance:textfield}

  .hint{margin-top:10px;font-size:14px;color:#a3e635;opacity:.95}
  .hint small{color:#93c5fd}

  table{width:100%;border-collapse:collapse;font-size:14px;background:#0b1223;border-radius:12px;overflow:hidden}
  thead th{text-align:left;padding:10px;background:#0f172a;color:#cbd5e1;border-bottom:1px solid #22314a;position:sticky;top:0;z-index:1}
  tbody td{padding:8px 10px;border-bottom:1px solid #1f2a3d}
  .right{text-align:right}
  .bank{font-weight:700;color:#86efac}
  .rpm-strong{font-weight:800;color:#fcd34d}

  .modebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .modebar .chip{padding:8px 12px}

  .fam-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .badge{background:#0b1223;border:1px solid #334155;border-radius:999px;padding:4px 8px;font-size:12px;color:#cbd5e1}
  .fam-section{border-top:1px solid #22314a;padding-top:8px;margin-top:10px}
  .fam-section h4{margin:4px 0 8px;font-size:13px;color:#cbd5e1;font-weight:900;letter-spacing:.3px}
  .fam-grid{display:grid;gap:6px;grid-template-columns:repeat(8,minmax(0,1fr))}
  @media (max-width:1000px){.fam-grid{grid-template-columns:repeat(6,minmax(0,1fr))}}
  @media (max-width:700px){.fam-grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .fam{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #334155;border-radius:10px;background:#0b1223;cursor:pointer}
  .fam input{accent-color:#22c55e;width:16px;height:16px}
  .fam span{font-weight:700}

  .swatch{width:12px;height:12px;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.35) inset}
  .swatch.kongle{background:#16a34a}.swatch.furu{background:#3b82f6}.swatch.gran{background:#f59e0b}.swatch.bjork{background:#ef4444}

  .diff{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;letter-spacing:.3px;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
  .diff.kongle{background:#166534;border:1px solid #22c55e;color:#f0fff4}
  .diff.furu{background:#1e3a8a;border:1px solid #60a5fa;color:#eef2ff}
  .diff.gran{background:#92400e;border:1px solid #f59e0b;color:#fff7ed}
  .diff.bjork{background:#7f1d1d;border:1px solid #ef4444;color:#fee2e2}

  .keypad{display:grid;gap:8px;grid-template-columns:repeat(7,minmax(0,1fr))}
  @media (max-width:560px){.keypad{grid-template-columns:repeat(5,minmax(0,1fr))}}
  .key{background:#0b1223;border:1px solid var(--ring);border-radius:12px;padding:12px 0;font-weight:900;font-size:18px;cursor:pointer;color:#e5e7eb}
  .key:active{transform:translateY(1px) scale(.99)}

  #errbar{position:fixed;left:0;right:0;top:0;background:#7f1d1d;color:#fee2e2;border-bottom:2px solid #ef4444;
    padding:8px 12px;font-size:13px;display:none;z-index:9999}

  /* task area + “Last CPM” near timer */
  .playbelt{
    display:grid; grid-template-columns: 1fr 280px; gap:12px; margin-top:12px; align-items:stretch;
  }
  @media (max-width:900px){ .playbelt{ grid-template-columns: 1fr; } }
  .sideStat{
    background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:6px;
  }
  .sideStat__label{font-size:12px;color:#9aa3b2;letter-spacing:.3px}
  .sideStat__value{font-variant-numeric:tabular-nums;font-weight:900;font-size:28px;color:#fcd34d}

  /* Collection (brainrot cards) */
  .collection-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .collection-grid{display:grid;gap:8px;grid-template-columns:repeat(5,minmax(0,1fr))}
  @media (max-width:900px){.collection-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .collect-card{position:relative;background:#0b1223;border:1px solid var(--ring);border-radius:12px;padding:10px}
  .collect-name{font-weight:800;font-size:14px;line-height:1.2}
  .collect-meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:12px;color:#cbd5e1}
  .badge-soft{border:1px solid #334155;border-radius:999px;padding:2px 8px;font-size:11px}
  .tier-Common{background:#0f172a}
  .tier-Uncommon{background:#0a1f10;border-color:#14532d}
  .tier-Rare{background:#0a1425;border-color:#1d4ed8}
  .tier-Epic{background:#220a2a;border-color:#a21caf}
  .tier-Legendary{background:#2a1a05;border-color:#b45309}
  .collect-count{font-variant-numeric:tabular-nums}
  .owned{border-color:#22c55e; box-shadow:0 0 0 2px #14532d inset, 0 0 18px rgba(34,197,94,.25)}
  .owned .collect-name{color:#bbf7d0}
  .owned-badge{position:absolute; top:8px; right:8px; background:#052e15; color:#a7f3d0; border:1px solid #22c55e; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:900;}
  .locked{opacity:.5; border-style:dashed}

  /* hide live CPM; show “Last CPM” instead */
  #cpm{display:none;}

  /* === Chests (loot) === */
  .loot-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .loot-grid{display:grid;gap:8px;grid-template-columns:repeat(3,minmax(0,1fr))}
  .loot-box{background:#0b1223;border:1px solid var(--ring);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px}
  .loot-tier{font-weight:800}
  .tier-bronze{color:#d1d5db}
  .tier-silver{color:#93c5fd}
  .tier-gold{color:#fcd34d}
  .loot-cta{display:flex;gap:8px;flex-wrap:wrap}
  .openres{margin-top:8px;padding:8px;border:1px dashed #334155;border-radius:10px;font-size:14px}
  .openres .rare{color:#60a5fa;font-weight:800}
  .openres .epic{color:#c084fc;font-weight:800}
  .openres .leg{color:#f59e0b;font-weight:900}
  .badge-hard{background:#0b1223;border:1px solid #334155;border-radius:999px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
<div id="errbar"></div>
<h1>Fact Families</h1>
<div class="wrap">

  <!-- TOP -->
  <div class="top">
    <div class="card">
      <div class="stats">
        <div class="stat"><div class="label">Bank (total)</div><div id="bankTotal" class="val">0</div></div>
        <div class="stat"><div class="label">Correct (current)</div><div id="correct" class="val">0</div></div>
        <div class="stat"><div class="label">CPM (correct/min)</div><div id="cpm" class="val">0.0</div></div>
      </div>
      <div class="pers">Personal best CPM: <b id="bestCpm">0.0</b></div>
      <div id="runFeedback" class="feedback"></div>
      <div class="row" style="background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px">
        <span>Goal (correct/min):</span>
        <input id="goalInput" type="number" min="1" max="200" step="1" style="width:110px;background:#0b1223;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:6px 8px">
        <span id="goalState" style="display:none;color:#16a34a;font-weight:800">Goal reached</span>
      </div>
    </div>

    <!-- TIMER + TASK + LAST CPM -->
    <div class="card">
      <div class="time-row">
        <div class="row">
          <span class="caps">round duration</span>
          <div id="durChips" class="chipgroup" role="group" aria-label="Round duration">
            <button class="chip" data-dur="0"  type="button">Stopwatch</button>
            <button class="chip" data-dur="10" type="button">10 s</button>
            <button class="chip" data-dur="30" type="button">30 s</button>
            <button class="chip active" data-dur="60" type="button">1 min</button>
            <button class="chip" data-dur="120" type="button">2 min</button>
          </div>
        </div>
        <div class="time-big" id="timeLeft">01:00</div>
      </div>
      <div class="progress" id="progressWrap"><div id="timeBar" class="bar"></div></div>

      <div class="playbelt">
        <div>
          <div class="stage stage--tight">
            <div id="eq" class="eq">
              <span class="cell" style="font-size:clamp(18px,3vw,30px);opacity:.9">
                Choose fact family/families and hit Start
              </span>
            </div>
          </div>
          <div id="hint" class="hint" aria-live="polite"></div>
        </div>
        <div class="sideStat">
          <div class="sideStat__label">Last CPM</div>
          <div id="lastCpm" class="sideStat__value">0.0</div>
        </div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="card" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
      <button id="startBtn" class="btn primary" type="button">Start (Enter)</button>
      <button id="pauseBtn" class="btn warn" type="button">Pause / Resume (Space)</button>
      <button id="stopBtn"  class="btn stop" type="button">Stop (S)</button>
      <button id="resetBtn" class="btn stop" type="button" title="Delete all saved results">Reset all</button>
    </div>
  </div>

  <!-- MODE -->
  <div class="card">
    <div class="modebar">
      <span class="caps">mode (game)</span>
      <button class="chip active" id="modeAdd"  data-mode="add" type="button">Add/Subtract</button>
      <button class="chip" id="modeMul" data-mode="mul" type="button">Multiply/Divide</button>
      <label style="display:flex;align-items:center;gap:8px;margin-left:auto">
        <input id="brainrotToggle" type="checkbox"> Brainrot mode (collectibles)
      </label>
    </div>
  </div>

  <!-- FAMILIES -->
  <div class="card">
    <div class="fam-tools">
      <span class="caps">families</span>
      <button id="famAll" class="btn" type="button">Select all</button>
      <button id="famNone" class="btn" type="button">Clear</button>
      <button id="famKongle" class="btn" type="button">All “Kongle”</button>
      <button id="famFuru" class="btn" type="button">All “Furu”</button>
      <button id="famGran" class="btn" type="button">All “Gran”</button>
      <button id="famBjork" class="btn" type="button">All “Bjørk”</button>
      <span class="badge">Selected: <span id="famCount">0</span></span>

      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span class="caps">difficulty</span>
        <span class="diff kongle">Kongle</span>
        <span class="diff furu">Furu</span>
        <span class="diff gran">Gran</span>
        <span class="diff bjork">Bjørk</span>
      </div>
    </div>
    <div id="famSections"></div>
  </div>

  <!-- CHESTS (optional, fully local) -->
  <div class="card">
    <div class="modebar" style="margin-bottom:8px">
      <span class="caps">chests</span>
      <label style="display:flex;align-items:center;gap:8px;margin-left:auto">
        <input id="lootToggle" type="checkbox"> Enable chests (CPM-based rewards)
      </label>
    </div>

    <div id="lootWrap" style="display:none">
      <div class="loot-head">
        <div class="badge-hard">Queue: <b id="lootQueueCount">0</b></div>
        <div class="badge-hard">Dust: <b id="dustCount">0</b></div>
      </div>

      <div class="loot-grid">
        <div class="loot-box">
          <div class="loot-tier tier-bronze">Bronze Chest</div>
          <div style="font-size:12px;color:#9aa3b2">Base odds • Guaranteed <i>Rare</i> within 10, <i>Epic</i> within 40 (pity)</div>
          <div class="loot-cta">
            <button id="openOneBtn" class="btn">Open 1</button>
            <button id="openFiveBtn" class="btn">Open 5</button>
            <button id="openAllBtn" class="btn">Open all</button>
          </div>
          <div id="openResult" class="openres" aria-live="polite"></div>
        </div>

        <div class="loot-box">
          <div class="loot-tier tier-silver">Silver Chest</div>
          <div style="font-size:12px;color:#9aa3b2">Better odds (CPM ≥ 30)</div>
          <div class="badge-hard">In queue: <b id="silverCount">0</b></div>
        </div>

        <div class="loot-box">
          <div class="loot-tier tier-gold">Gold Chest</div>
          <div style="font-size:12px;color:#9aa3b2">Best odds (CPM ≥ 50)</div>
          <div class="badge-hard">In queue: <b id="goldCount">0</b></div>
        </div>
      </div>

      <div style="margin-top:10px;font-size:12px;color:#9aa3b2">
        Duplicate → dust (Common 1 • Uncommon 3 • Rare 8 • Epic 20 • Legendary 50). 40 dust = craft any not-owned card (can be added).
      </div>
    </div>
  </div>

  <!-- MOBILE KEYPAD -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Keypad (mobile)</div>
    <div id="keypad" class="keypad"></div>
  </div>

  <!-- BONUS -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Speed → Extra points</div>
    <div style="display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))">
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>≥ 10 CPM</span><span>+ 10</span></div>
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>&gt; 20 CPM</span><span>+ 30</span></div>
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>&gt; 30 CPM</span><span>+ 50</span></div>
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>&gt; 40 CPM</span><span>+ 70</span></div>
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>&gt; 50 CPM</span><span>+ 100</span></div>
      <div class="row" style="justify-content:space-between;background:#0b1223;border:1px dashed #334155;border-radius:12px;padding:8px 10px"><span>&gt; 60 CPM</span><span>+ 200</span></div>
    </div>
    <div style="color:#9aa3b2;font-size:13px;margin-top:6px">Bank per round = floor(CPM) + bonus</div>
  </div>

  <!-- COLLECTION (only visible in Brainrot mode) -->
  <div id="collectionCard" class="card" style="display:none">
    <div class="collection-head">
      <div style="font-weight:800">Brainrot Collection</div>
      <div class="row">
        <label class="row" style="gap:6px"><input id="toggleMineOnly" type="checkbox"> Show mine only</label>
        <div class="badge-soft">Total value: <span id="collectionValue">0</span></div>
      </div>
    </div>

    <div id="mineWrap">
      <div class="caps" style="margin:6px 0 8px">My cards</div>
      <div id="collectionGridMine" class="collection-grid"></div>
    </div>

    <div id="othersWrap" style="margin-top:10px">
      <div class="caps" style="margin:6px 0 8px">The others</div>
      <div id="collectionGridOthers" class="collection-grid"></div>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px">Results (all rounds)</div>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Mode</th>
          <th>Families</th>
          <th class="right">Correct</th>
          <th class="right">Wrong</th>
          <th class="right">Duration (s)</th>
          <th class="right rpm-strong">CPM</th>
          <th class="right">Bonus</th>
          <th class="right">Bank +</th>
          <th class="right">Bank (sum)</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

</div>

<footer style="text-align:center;color:#9aa3b2;padding:14px">
  Suggestions? Contact
  <a href="mailto:dag.gladmann.sorheim@gmail.com">dag.gladmann.sorheim@gmail.com</a>
</footer>

<!-- 3s countdown -->
<div id="overlay" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.65);z-index:100;backdrop-filter:blur(3px)">
  <div id="count" style="font-size:clamp(42px,10vw,120px);font-weight:900">3</div>
</div>

<!-- Brainrot banner -->
<div id="sigmaBackdrop" style="display:none;place-items:center;position:fixed;inset:0;background:rgba(2,6,23,.6);z-index:200;backdrop-filter:blur(2px);">
  <div id="sigmaSign" style="background:#0b1223;border:2px solid #334155;border-radius:18px;padding:22px 26px;max-width:90vw;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.6);">
    <div id="sigmaText" style="font-size:clamp(22px, 4.5vw, 40px);font-weight:900;line-height:1.25;">Great job!</div>
    <div id="sigmaHint" style="margin-top:6px;color:#9aa3b2;font-size:13px">Click to close</div>
  </div>
</div>

<script>
(function(){
'use strict';

/* ========= Hard fail banner ========= */
const errbar=document.getElementById('errbar');
window.addEventListener('error', (ev)=>{
  errbar.style.display='block';
  errbar.textContent='Script error: ' + (ev.message||'unknown error') + ' (see console for details)';
});
const log = (...a)=>console.log('[FF]',...a);

/* ========= Helpers ========= */
const $=id=>document.getElementById(id);
const pad=n=>String(n).padStart(2,'0');
const shuffle=a=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
const fmtTime=s=>{ if(s===null) return '—'; s=Math.max(0,Math.ceil(s)); return `${pad(Math.floor(s/60))}:${pad(s%60)}`; };
const ts=()=>{ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
const bonusForCPM=r=> r>60?200:r>50?100:r>40?70:r>30?50:r>20?30:r>=10?10:0;

/* ========= Brainrot cards ========= */
const TIERS = {
  Common:     {weight: 50, value: 5},
  Uncommon:   {weight: 25, value: 12},
  Rare:       {weight: 15, value: 30},
  Epic:       {weight: 8,  value: 80},
  Legendary:  {weight: 2,  value: 180}
};

const BRAINROT = [
  {name:"Tralalero Tralala",            tier:"Common"},
  {name:"Ballerina Cappucina",          tier:"Common"},
  {name:"Capybarelli Bananalelli",      tier:"Common"},
  {name:"Chimpanzini Bananini",         tier:"Common"},
  {name:"Penguino Cocosino",            tier:"Common"},
  {name:"Bobrelli Bananelli",           tier:"Common"},
  {name:"Blueberrini Tatticini",        tier:"Uncommon"},
  {name:"Frulli Frulla",                tier:"Uncommon"},
  {name:"Piccione Macchina",            tier:"Uncommon"},
  {name:"Kiwitto Banditto",             tier:"Uncommon"},
  {name:"Leonelli Cactuselli",          tier:"Uncommon"},
  {name:"Chai Maestro",                 tier:"Uncommon"},
  {name:"La Vaca Saturno",              tier:"Rare"},
  {name:"Orcalero Orcala",              tier:"Rare"},
  {name:"Girafa Celeste",               tier:"Rare"},
  {name:"Ecco Cavallo Virtuoso",        tier:"Rare"},
  {name:"Espressona Signora",           tier:"Rare"},
  {name:"Gorillo Watermellondrillo",    tier:"Epic"},
  {name:"Graipussi Medussi",            tier:"Epic"},
  {name:"Tric Trac Baraboom",           tier:"Epic"},
  {name:"Frigo Camelo",                 tier:"Epic"},
  {name:"Nuclearo Dinossauro",          tier:"Legendary"},
  {name:"Burbaloni Lulilolli",          tier:"Legendary"},
  {name:"Il Cacto Ippopotamo",          tier:"Legendary"},
  {name:"Pot Hotspot",                  tier:"Legendary"}
];

function pickBrainrot(cpm){
  const steps = Math.max(0, Math.floor((cpm - 20)/10));
  const pool = BRAINROT.map((card, idx) => {
    let w = TIERS[card.tier].weight;
    if(steps>0){
      if(card.tier==="Legendary") w += steps*1.2;
      if(card.tier==="Epic")      w += steps*1.0;
      if(card.tier==="Rare")      w += steps*0.7;
      if(card.tier==="Uncommon")  w += steps*0.3;
      if(card.tier==="Common")    w -= steps*1.5;
      w = Math.max(0.1, w);
    }
    return {idx, weight:w};
  });
  const total = pool.reduce((s,p)=>s+p.weight,0);
  let r = Math.random()*total;
  for(const p of pool){
    if((r-=p.weight) <= 0) return BRAINROT[p.idx];
  }
  return BRAINROT[0];
}

/* ========= Families ========= */
// Add: c=2..20, a<=b
const FAMS_ADD=[];
for(let c=2;c<=20;c++){ for(let a=1;a<=Math.floor(c/2);a++){ const b=c-a; FAMS_ADD.push({a,b,c,id:`A:${a}-${b}-${c}`}); } }
// Mul: 1..12, a<=b
const FAMS_MUL=[];
for(let a=1;a<=12;a++){ for(let b=a;b<=12;b++){ const c=a*b; FAMS_MUL.push({a,b,c,id:`M:${a}-${b}-${c}`}); } }

const familyItemsAdd=f=>[
  {op:'+', pattern:[f.a,f.b,f.c], fam:f.id},
  {op:'+', pattern:[f.b,f.a,f.c], fam:f.id},
  {op:'-', pattern:[f.c,f.a,f.b], fam:f.id},
  {op:'-', pattern:[f.c,f.b,f.a], fam:f.id},
];
const familyItemsMul=f=>[
  {op:'×', pattern:[f.a,f.b,f.c], fam:f.id},
  {op:'×', pattern:[f.b,f.a,f.c], fam:f.id},
  {op:'÷', pattern:[f.c,f.a,f.b], fam:f.id},
  {op:'÷', pattern:[f.c,f.b,f.a], fam:f.id},
];
const famLabel=id=>id.slice(2).split('-').join(' ');

/* ========= Difficulty labels (kept Norwegian tags as categories) ========= */
const DIFF_LABEL={kongle:'Kongle', furu:'Furu', gran:'Gran', bjork:'Bjørk'};
const diffForAdd=c => c<=6?'kongle':c<=10?'furu':c<=15?'gran':'bjork';
const diffForMul=z => z<=25?'kongle':z<=64?'furu':z<=100?'gran':'bjork';
const diffForFamily=(f,isAdd)=> ({key: isAdd?diffForAdd(f.c):diffForMul(f.c), label: DIFF_LABEL[isAdd?diffForAdd(f.c):diffForMul(f.c)]});
const DIFF_ORDER=['kongle','furu','gran','bjork'];

/* ========= Storage ========= */
const KEY='fact_families_v6_en_cpm';
let bankTotal=0, bestCPM=0, goalCPM=null, results=[];
let mode='add', brainrotOn=false;
let selectedAdd=new Set(), selectedMul=new Set();
let collection = {};     // { name: count }
let collectionValue = 0; // total value

/* === Loot storage === */
let lootOn = false;
let lootBronze = 0, lootSilver = 0, lootGold = 0;
let pityRare = 0, pityEpic = 0;
let dust = 0;

const BASE_ODDS = { Common:60, Uncommon:25, Rare:10, Epic:4, Legendary:1 };
const SILVER_BONUS = { Rare:+5, Epic:+2, Legendary:+1 };
const GOLD_BONUS   = { Rare:+10, Epic:+5, Legendary:+2 };
const DUST_VALUE = { Common:1, Uncommon:3, Rare:8, Epic:20, Legendary:50 };

function loadLoot(o){
  lootOn     = !!o.lootOn;
  lootBronze = +o.lootBronze || 0;
  lootSilver = +o.lootSilver || 0;
  lootGold   = +o.lootGold   || 0;
  pityRare   = +o.pityRare   || 0;
  pityEpic   = +o.pityEpic   || 0;
  dust       = +o.dust       || 0;
}
function saveLoot(obj){
  Object.assign(obj, {lootOn,lootBronze,lootSilver,lootGold,pityRare,pityEpic,dust});
}

function loadStore(){
  try{
    const raw=localStorage.getItem(KEY); if(!raw) return;
    const o=JSON.parse(raw);
    bankTotal=+o.bankTotal||0; bestCPM=+o.bestCPM||0; goalCPM=(o.goalCPM==null?null:+o.goalCPM);
    results=Array.isArray(o.results)?o.results:[];
    mode=(o.mode==='mul')?'mul':'add';
    brainrotOn = !!o.brainrotOn;
    selectedAdd=new Set(o.selAdd||[]); selectedMul=new Set(o.selMul||[]);
    collection = o.collection || {};
    collectionValue = +o.collectionValue || 0;
    loadLoot(o);
  }catch(e){ console.warn(e); }
}
function saveStore(){
  try{
    const obj = {
      bankTotal,bestCPM,goalCPM,results,mode,brainrotOn,
      selAdd:[...selectedAdd], selMul:[...selectedMul],
      collection, collectionValue
    };
    saveLoot(obj);
    localStorage.setItem(KEY, JSON.stringify(obj));
  }catch(e){ console.warn(e); }
}

/* ========= Family UI ========= */
const famSections=$('famSections'), famCount=$('famCount');
const familiesForMode = m => m==='add'?FAMS_ADD:FAMS_MUL;
const selectionSet     = () => mode==='add'?selectedAdd:selectedMul;
const itemsForFamily   = f => mode==='add'?familyItemsAdd(f):familyItemsMul(f);

function renderFamilySections(){
  const list=familiesForMode(mode);
  const groups={kongle:[],furu:[],gran:[],bjork:[]};
  list.forEach(f=>groups[diffForFamily(f,mode==='add').key].push(f));
  const sel=selectionSet();

  famSections.innerHTML='';
  for(const k of DIFF_ORDER){
    const arr=groups[k]; if(!arr.length) continue;
    const sec=document.createElement('div'); sec.className='fam-section';
    const h=document.createElement('h4'); h.innerHTML=`<span class="diff ${k}">${DIFF_LABEL[k]}</span>`;
    const grid=document.createElement('div'); grid.className='fam-grid';
    for(const f of arr){
      const lab=document.createElement('label'); lab.className='fam';
      lab.innerHTML=`<span class="swatch ${k}" aria-hidden="true"></span>
        <input type="checkbox" ${sel.has(f.id)?'checked':''} data-id="${f.id}">
        <span>${f.a} ${f.b} ${f.c}</span>`;
      grid.appendChild(lab);
    }
    sec.append(h,grid); famSections.appendChild(sec);
  }

  famSections.onchange=(e)=>{
    const cb = (e.target && e.target.matches && e.target.matches('input[type="checkbox"]')) ? e.target : null;
    if(!cb) return;
    const set=selectionSet();
    if(cb.checked) set.add(cb.dataset.id); else set.delete(cb.dataset.id);
    famCount.textContent=[...set].length; saveStore();
  };

  famCount.textContent=[...sel].length;
}

/* ========= Mode & toggles ========= */
$('modeAdd').addEventListener('click',()=>{ if(mode!=='add'){ mode='add'; $('modeAdd').classList.add('active'); $('modeMul').classList.remove('active'); renderFamilySections(); saveStore(); } });
$('modeMul').addEventListener('click',()=>{ if(mode!=='mul'){ mode='mul'; $('modeMul').classList.add('active'); $('modeAdd').classList.remove('active'); renderFamilySections(); saveStore(); } });
$('brainrotToggle').addEventListener('change',()=>{
  brainrotOn=$('brainrotToggle').checked; saveStore(); updateBrainrotUI();
});

/* ========= Game state ========= */
let running=false, paused=false, sessionDur=60, startMs=0, pauseAccum=0, pauseStart=0, tickTimer=null;
let correct=0, wrong=0, idx=0, queue=[], currentSolution=0, currentItem=null;
let hintTimer=null;
const getElapsed = () => !startMs ? 0 : (((paused?pauseStart:Date.now())-startMs)-pauseAccum)/1000;

/* ========= HUD ========= */
function updateHUD(){
  const e=getElapsed();
  const cpm = e>0 ? (correct/(e/60)) : 0;
  $('correct').textContent=String(correct);
  $('cpm').textContent=cpm.toFixed(1);
  $('bankTotal').textContent=String(bankTotal);
  $('bestCpm').textContent=bestCPM.toFixed(1);
  $('goalState').style.display=(goalCPM!=null && cpm>=goalCPM)?'inline':'none';

  if(sessionDur===0){
    $('timeLeft').textContent = fmtTime(e);
    $('progressWrap').style.visibility='hidden';
  } else {
    $('progressWrap').style.visibility='visible';
    const elapsed=Math.min(sessionDur,Math.max(0,e));
    const left=Math.max(0,sessionDur-elapsed);
    $('timeLeft').textContent=fmtTime(left);
    $('timeBar').style.width=`${Math.max(0,Math.min(100,(elapsed/sessionDur)*100))}%`;
  }
}

/* ========= Tasks ========= */
function renderInput(){ return `<input id="ansInput" class="numbox" type="text" inputmode="numeric" autocomplete="off" pattern="[0-9]*">`; }
function setEquation(item){
  clearHint();
  currentItem=item; const [x,y,z]=item.pattern; const sign=item.op;
  const missIndex=Math.floor(Math.random()*3);
  $('eq').innerHTML=[
    missIndex===0?renderInput():`<span class="cell">${x}</span>`,
    `<span class="op">${sign}</span>`,
    missIndex===1?renderInput():`<span class="cell">${y}</span>`,
    `<span class="eqsign">=</span>`,
    missIndex===2?renderInput():`<span class="cell">${z}</span>`
  ].join('');
  currentSolution=[x,y,z][missIndex];

  startHintTimer();

  const inp=$('ansInput');
  if(inp){
    const blockKeys = e => { if(['ArrowUp','ArrowDown','PageUp','PageDown'].includes(e.key)) e.preventDefault(); };
    const blockWheel = e => e.preventDefault();
    inp.addEventListener('keydown', blockKeys, {passive:false});
    inp.addEventListener('wheel', blockWheel, {passive:false});
    inp.addEventListener('input', () => {
      inp.value = inp.value.replace(/\D+/g,'').slice(0,3);
      onType();
    });
    inp.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){ e.preventDefault(); submitAnswer(); }
    });
    inp.focus({preventScroll:true});
  }
}
function onType(){
  if(!running || paused) return;
  const inp = $('ansInput'); if(!inp) return;
  const v = inp.value.trim();
  if(v==='') return;
  const need = String(currentSolution).length;
  if (v.length >= need || +v === currentSolution) {
    submitAnswer();
  }
}
function markInput(ok){ const inp=$('ansInput'); if(!inp) return; inp.classList.remove('ok','err'); inp.classList.add(ok?'ok':'err'); }

/* ======== Hint ======== */
function startHintTimer(){
  if(hintTimer) clearTimeout(hintTimer);
  hintTimer = setTimeout(()=>{
    if(!running || paused) return;
    $('hint').innerHTML = `<small>Hint:</small> ${currentSolution}`;
  }, 3000);
}
function clearHint(){
  if(hintTimer){ clearTimeout(hintTimer); hintTimer=null; }
  const hint = $('hint'); if(hint) hint.textContent = '';
}

function buildQueueFromSelection(){
  const list=familiesForMode(mode), sel=selectionSet();
  const chosen=list.filter(f=>sel.has(f.id));
  const items=[]; chosen.forEach(f=>items.push(...(mode==='add'?familyItemsAdd(f):familyItemsMul(f))));
  shuffle(items); return items;
}
function nextItem(){
  if(idx>=queue.length){ queue=queue.concat(buildQueueFromSelection()); if(queue.length===0){ finishRun(); return; } }
  setEquation(queue[idx]); updateHUD();
}
function submitAnswer(){
  if(!running||paused) return;
  const val=$('ansInput')?.value?.trim(); if(val==='') return;
  const ok=(+val===currentSolution);
  if(ok){ correct++; markInput(true); }
  else { wrong++; markInput(false); queue.splice(idx+1,0,currentItem,currentItem,currentItem); }
  idx++;
  clearHint();
  setTimeout(nextItem,70); updateHUD();
}

/* ========= Start/Stop + countdown ========= */
$('startBtn').addEventListener('click',()=>{ if(!running) startCountdown(); });
$('pauseBtn').addEventListener('click',()=>{ if(!running) return; if(!paused){ paused=true; pauseStart=Date.now(); $('runFeedback').textContent='Paused'; } else { paused=false; pauseAccum += Date.now()-pauseStart; pauseStart=0; $('runFeedback').textContent=''; } });
$('stopBtn').addEventListener('click',()=>{ if(!running) return; finishRun(); });
$('resetBtn').addEventListener('click',()=>{
  if(!confirm('Reset all saved results, bank and collection?')) return;
  bankTotal=0; bestCPM=0; results=[];
  collection={}; collectionValue=0;
  lootBronze=0; lootSilver=0; lootGold=0; pityRare=0; pityEpic=0; dust=0;
  renderResults(); renderCollection(); renderLoot(); updateHUD(); saveStore();
  $('lastCpm').textContent='0.0'; clearHint();
});

function startCountdown(){
  $('overlay').style.display='grid'; let t=3; $('count').textContent=t;
  const iv=setInterval(()=>{ t--; if(t>0){ $('count').textContent=t; } else { $('count').textContent='GO!'; setTimeout(()=>{ $('overlay').style.display='none'; clearInterval(iv); beginRun(); },600);} },1000);
}
function beginRun(){
  if(selectionSet().size===0){ alert('Select at least one fact family before starting.'); return; }
  $('runFeedback').textContent=''; running=true; paused=false; correct=0; wrong=0; idx=0;
  const act=document.querySelector('#durChips .chip.active'); const d = Number(act && act.dataset ? act.dataset.dur : 60);
  sessionDur = Number.isFinite(d) ? d : 60; // 0=stopwatch
  startMs=Date.now(); pauseAccum=0; pauseStart=0;
  queue=buildQueueFromSelection(); $('timeBar').style.width='0%';
  if(sessionDur===0){ $('progressWrap').style.visibility='hidden'; $('timeLeft').textContent='00:00'; }
  if(queue.length===0){ running=false; return; }
  clearHint();
  nextItem();
  if(tickTimer) clearInterval(tickTimer);
  tickTimer=setInterval(()=>{ if(!running||paused) return; updateHUD(); if(sessionDur>0 && getElapsed()>=sessionDur){ finishRun(); } },100);
}

/* ========= Collection rendering ========= */
function renderCollection(){
  const mineGrid = $('collectionGridMine');
  const othersGrid = $('collectionGridOthers');
  if(!mineGrid || !othersGrid) return;

  const mine = [];
  const others = [];
  BRAINROT.forEach(card=>{
    const cnt = collection[card.name]||0;
    const val = TIERS[card.tier].value;
    const base = `
      <div class="collect-card ${cnt>0?'owned':'locked'}">
        ${cnt>0?`<span class="owned-badge">x${cnt}</span>`:''}
        <div class="collect-name">${card.name}</div>
        <div class="collect-meta">
          <span class="badge-soft ${'tier-'+card.tier}">${card.tier}</span>
          <span class="collect-count">${cnt>0?('x'+cnt):'—'}</span>
        </div>
        <div class="collect-meta" style="margin-top:4px">
          <span class="badge-soft">Value: ${val}</span><span></span>
        </div>
      </div>`;
    if(cnt>0) mine.push(base); else others.push(base);
  });

  mineGrid.innerHTML = mine.join('') || `<div style="opacity:.8">No cards yet – play in Brainrot mode to collect.</div>`;
  othersGrid.innerHTML = others.join('');

  $('collectionValue').textContent = collectionValue;

  const only = $('toggleMineOnly')?.checked;
  $('othersWrap').style.display = only ? 'none' : '';
  $('mineWrap').style.display = '';
}

/* ========= Sigma banner (if brainrot enabled) ========= */
function awardCardsWithSigma(cpm){
  const maxPerRun = 5;
  const extra = Math.floor(cpm / 40);
  const n = Math.max(1, Math.min(1 + extra, maxPerRun));

  const gained = [];
  for(let i=0;i<n;i++){
    const card = pickBrainrot(cpm);
    const tierInfo = TIERS[card.tier];
    collection[card.name] = (collection[card.name]||0) + 1;
    collectionValue += tierInfo.value;
    gained.push({name:card.name, tier:card.tier, value:tierInfo.value});
  }
  saveStore();
  renderCollection();

  const rarityRank = {Legendary:5, Epic:4, Rare:3, Uncommon:2, Common:1};
  gained.sort((a,b)=>rarityRank[b.tier]-rarityRank[a.tier]);
  const primary = gained[0];
  const otherCount = gained.length-1;
  const extraLine = otherCount>0 ? ` + ${otherCount} more` : '';
  const phrase = `You are as sigma as ${primary.name}! (value +${primary.value})${extraLine}`;

  const backdrop=$('sigmaBackdrop'), text=$('sigmaText');
  text.textContent=phrase; backdrop.style.display='grid';
  try{ const u=new SpeechSynthesisUtterance(phrase); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
  const hide=()=>{ backdrop.style.display='none'; backdrop.removeEventListener('click',hide); };
  backdrop.addEventListener('click',hide); setTimeout(hide,3500);
}

/* ========= Loot UI ========= */
function renderLoot(){
  const on = lootOn;
  const wrap = $('lootWrap'); if(wrap) wrap.style.display = on ? '' : 'none';
  $('lootQueueCount') && ($('lootQueueCount').textContent = (lootBronze+lootSilver+lootGold));
  $('silverCount') && ($('silverCount').textContent = lootSilver);
  $('goldCount') && ($('goldCount').textContent   = lootGold);
  $('dustCount') && ($('dustCount').textContent   = dust);
  $('lootToggle') && ($('lootToggle').checked = lootOn);
}
$('lootToggle')?.addEventListener('change',()=>{
  lootOn = $('lootToggle').checked;
  saveStore(); renderLoot();
});

/* ========= Loot: odds & opening ========= */
function oddsForTier(tier){
  const o = {...BASE_ODDS};
  const bonus = tier==='gold' ? GOLD_BONUS : tier==='silver' ? SILVER_BONUS : null;
  if(bonus){
    let take = 0;
    for(const k of Object.keys(bonus)){ o[k]+=bonus[k]; take += bonus[k]; }
    o.Common = Math.max(0, o.Common - take);
  }
  const sum = Object.values(o).reduce((a,b)=>a+b,0);
  for(const k in o){ o[k] = o[k]*100/sum; }
  return o;
}
function drawRarity(baseOdds, pityRareNow, pityEpicNow){
  if(pityEpicNow>=39) return 'Epic';
  if(pityRareNow>=9)  return 'Rare';
  const r = Math.random()*100;
  let acc=0;
  for(const [rar, p] of Object.entries(baseOdds)){
    acc += Math.max(0,p);
    if(r <= acc) return rar;
  }
  return 'Common';
}
function openOne(){
  let tier=null;
  if(lootGold>0){ tier='gold'; lootGold--; }
  else if(lootSilver>0){ tier='silver'; lootSilver--; }
  else if(lootBronze>0){ tier='bronze'; lootBronze--; }
  else return null;

  const o = oddsForTier(tier);
  const rarity = drawRarity(o, pityRare, pityEpic);
  pityRare++; pityEpic++;
  if(rarity==='Rare'){ pityRare=0; }
  if(rarity==='Epic' || rarity==='Legendary'){ pityEpic=0; pityRare=0; }

  const pool = BRAINROT.filter(c=>c.tier===rarity);
  const card = pool[Math.floor(Math.random()*pool.length)];

  if(!collection[card.name]) collection[card.name]=0;
  let dup = false;
  if(collection[card.name]>0){ dup = true; dust += DUST_VALUE[rarity]; }
  collection[card.name] += 1;

  saveStore(); renderLoot(); renderCollection();

  return {tier, rarity, card:card.name, dup, dustGained: dup?DUST_VALUE[rarity]:0};
}
function openN(n){
  const res=[];
  for(let i=0;i<n;i++){
    const r = openOne();
    if(!r) break;
    res.push(r);
  }
  return res;
}
$('openOneBtn')?.addEventListener('click', ()=>{
  const r = openN(1);
  showOpenResult(r);
});
$('openFiveBtn')?.addEventListener('click', ()=>{
  const r = openN(5);
  showOpenResult(r);
});
$('openAllBtn')?.addEventListener('click', ()=>{
  const total = lootBronze+lootSilver+lootGold;
  const r = openN(total);
  showOpenResult(r);
});
function showOpenResult(list){
  const box=$('openResult'); if(!box) return;
  if(!list || !list.length){ box.textContent='No chests to open.'; return; }
  const lines = list.map(x=>{
    const cls = x.rarity==='Legendary'?'leg':x.rarity==='Epic'?'epic':x.rarity==='Rare'?'rare':'';
    const dupTxt = x.dup?` (duplicate → +${x.dustGained} dust)`:``;
    const tierTxt = x.tier==='gold'?'Gold':x.tier==='silver'?'Silver':'Bronze';
    return `${tierTxt}: <span class="${cls}">${x.rarity}</span> – ${x.card}${dupTxt}`;
  });
  box.innerHTML = lines.join('<br>');
}

/* ========= Loot: chests from CPM (every 5 over 15) ========= */
function grantChestsFromCPM(cpm){
  if(!lootOn) return;
  let n = 0;
  if(cpm >= 15) {
    n = 1 + Math.floor((cpm - 15) / 5);
    n = Math.min(n, 10); // cap
  }
  if(n <= 0) return;

  let tier = 'bronze';
  if(cpm >= 50) tier = 'gold';
  else if(cpm >= 30) tier = 'silver';

  if(tier === 'gold') lootGold += n;
  else if(tier === 'silver') lootSilver += n;
  else lootBronze += n;

  saveStore(); renderLoot();

  $('runFeedback').textContent =
    `You earned ${n} ${tier==='gold'?'Gold':tier==='silver'?'Silver':'Bronze'} chest${n>1?'s':''}!`;
}

/* ========= Results (cumulative sum aligned with row) ========= */
function renderResults(){
  const body=$('resultsBody');

  const sums=[]; let acc=0;
  for(let i=results.length-1;i>=0;i--){ acc += (+results[i].add||0); sums[i]=acc; }

  body.innerHTML = results.map((r,i)=>`
    <tr>
      <td>${r.time}</td>
      <td>${r.mode||''}</td>
      <td>${r.fams||''}</td>
      <td class="right">${r.correct}</td>
      <td class="right">${r.wrong}</td>
      <td class="right">${r.dur}</td>
      <td class="right rpm-strong">${(Number.isFinite(+r.cpm)?(+r.cpm).toFixed(1):'0.0')}</td>
      <td class="right">${r.bonus}</td>
      <td class="right bank">+${r.add}</td>
      <td class="right bank">${sums[i]}</td>
    </tr>
  `).join('');

  $('bankTotal').textContent = acc || 0;
  $('bestCpm').textContent  = bestCPM.toFixed(1);
  $('lastCpm').textContent = results[0] ? (Number(results[0].cpm).toFixed(1)) : '0.0';
}

/* ========= Duration chips ========= */
$('durChips').addEventListener('click',(e)=>{
  const btn=e.target.closest('.chip'); if(!btn) return;
  [...$('durChips').querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  const d=Number(btn.dataset.dur);
  $('timeLeft').textContent = (d===0)?'00:00':fmtTime(d);
  $('timeBar').style.width='0%';
  $('progressWrap').style.visibility=(d===0)?'hidden':'visible';
});

/* ========= Goal ========= */
$('goalInput').addEventListener('change',()=>{
  const v=$('goalInput').value.trim(); goalCPM = v==='' ? null : Math.max(1, Math.min(200, +v)); saveStore();
});

/* ========= Mobile keypad ========= */
(function buildKeypad(){
  const keys = ['1','2','3','4','5','6','7','8','9','0','⌫','OK'];
  const frag = document.createDocumentFragment();
  keys.forEach(k=>{
    const b=document.createElement('button');
    b.type='button'; b.className='key'; b.textContent=k; b.dataset.key=k;
    frag.appendChild(b);
  });
  $('keypad').innerHTML='';
  $('keypad').appendChild(frag);

  $('keypad').addEventListener('click',e=>{
    const btn=e.target.closest('.key'); if(!btn||!running||paused) return;
    const k=btn.dataset.key; const inp=$('ansInput'); if(!inp) return;

    if(k==='OK'){ submitAnswer(); return; }
    if(k==='⌫'){ inp.value = (inp.value||'').slice(0,-1); onType(); return; }
    if(/\d/.test(k)){
      const next=(inp.value||'') + k;
      inp.value = next.slice(0,3);
      onType();
    }
  });
})();

/* ========= Brainrot UI toggle ========= */
$('toggleMineOnly')?.addEventListener('change',()=>renderCollection());
function updateBrainrotUI(){
  const card = $('collectionCard');
  if(card) card.style.display = brainrotOn ? '' : 'none';
}

/* ========= Finish round ========= */
function finishRun(){
  const endRef=paused?pauseStart:Date.now();
  const elapsed=Math.max(0,(endRef-startMs-pauseAccum)/1000);
  const cpm = elapsed>0 ? (correct/(elapsed/60)) : 0;
  const base=Math.floor(cpm), bonus=bonusForCPM(cpm), add=(isFinite(base)?base:0) + (isFinite(bonus)?bonus:0);
  const newRecord=cpm>bestCPM, goalHit=(goalCPM!=null && cpm>=goalCPM);
  running=false; clearInterval(tickTimer);
  bankTotal += add; if(newRecord) bestCPM=cpm;

  const usedFamIds=new Set(); for(let i=0;i<idx;i++){ const it=queue[i]; if(it&&it.fam) usedFamIds.add(it.fam); }
  const fams=[...usedFamIds].map(famLabel).join(' | ');
  const modeLabel=mode==='add'?'Add/Subtract':'Multiply/Divide';

  results.unshift({ time:ts(), mode:modeLabel, fams, correct, wrong,
    dur:Math.round(sessionDur===0?elapsed:Math.min(sessionDur,elapsed)),
    cpm:+(isFinite(cpm)?cpm.toFixed(1):'0'), bonus, add });

  $('lastCpm').textContent = cpm.toFixed(1);

  renderResults(); updateHUD(); saveStore();

  const msg =
    newRecord && goalHit ? 'New personal best and goal reached.' :
    newRecord ? 'New personal best.' :
    goalHit ? 'Goal reached.' : `Done – CPM: ${cpm.toFixed(1)}`;
  $('runFeedback').textContent = msg;
  $('eq').innerHTML=`<span class="cell" style="font-size:clamp(18px,3vw,32px)">Ready for a new round – press Start</span>`;
  clearHint();

  if(brainrotOn){ awardCardsWithSigma(cpm); }
  grantChestsFromCPM(cpm); // CPM-based chests (every 5 over 15)
  renderLoot();
}

/* ========= Init ========= */
function init(){
  loadStore();
  $('modeAdd').classList.toggle('active', mode==='add');
  $('modeMul').classList.toggle('active', mode==='mul');
  $('brainrotToggle').checked=brainrotOn;

  renderFamilySections();
  renderResults();
  renderCollection();
  updateBrainrotUI();
  renderLoot();

  const activeBtn = document.querySelector('#durChips .chip.active');
  const d = Number(activeBtn && activeBtn.dataset ? activeBtn.dataset.dur : 60);
  $('timeLeft').textContent = (d===0)?'00:00':fmtTime(d);
  $('progressWrap').style.visibility=(d===0)?'hidden':'visible';

  document.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='Enter'){ e.preventDefault(); if(!running) $('startBtn').click(); }
    if(k===' '||k==='Spacebar'){ e.preventDefault(); $('pauseBtn').click(); }
    if(k==='s'||k==='S'){ e.preventDefault(); $('stopBtn').click(); }
  });
}
document.addEventListener('DOMContentLoaded', init);

})();</script>
</body>
</html>
